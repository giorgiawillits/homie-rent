    
<div class="ibox">
  <div style="padding-bottom: 50px;" class="ibox-title">
    <div class="form-group btn-group m-b-none pull-right" data-toggle="buttons">
        <label class="btn btn-default split-method split-method-active active" id="split-method-equal">
          <input type="radio" value="equal" />
          =
        </label>
        <label class="btn btn-default split-method split-method-inactive" id="split-method-dollars">
          <input type="radio" value="dollars" />
          $
        </label>
        <label class="btn btn-default split-method split-method-inactive" id="split-method-percent">
          <input type="radio" value="percent" />
          %
        </label>
        <label class="btn btn-default split-method split-method-inactive" id="split-method-unit">
          <input type="radio" value="unit" />
          <i class="fa fa-th"></i>
        </label>
      </div>
    <h5 style="padding-bottom: 15px;">Charge calculator</h5>
  </div>
  
  <% current_house_members.each_with_index do |user, i| %> 
    <div class="ibox-content p-xxs">
      <div class="table-responsive">
        <table class="table shoping-cart-table">
          <tbody><tr class="split-row user-paying" data-row_id="<%= i %>">
            <td class="col-md-1"><i class="fa fa-check-square-o split-font split-checkbox"></i></td>
            <td class="col-md-5 desc"><h3><div class="text-navy"><label for="user-<%= i %>"><%= user.full_name %></label></div></h3></td>
            <td class="col-md-3">
              <div class="input-group split-col-hidden hidden split-method-percent split-method-unit">
                <input class="form-control user-share" id="user-share-<%= i %>" type="text"/>
                <span class="input-group-addon split-col-hidden hidden split-method-percent">%</span>
                <span class="input-group-addon split-col-hidden hidden split-method-unit">units</span>
              </div>
            </td>
            <td class="col-md-3">
              <div class="input-group">
                <span class="input-group-addon">$</span>
                <input class="form-control user-amount" id="user-input-<%= i %>" type="text" name="charges[users][<%= user.id %>]">
              </div>
              <div class="hidden" id="user-amount-<%= i %>"><h4></h4></div>
            </td>
          </tr></tbody>
        </table>
      </div>
    </div>
  <% end %>
</div>
  
  
  
  
  
<script>
  $(document).ready(function() {
    
    var calculateCharges = function() {
      var splitMethod = $(".split-method-active").attr("id");
      if (splitMethod == "split-method-equal") {
        calculateEqualCharges();
      } else if (splitMethod == "split-method-dollars") {
        $(".user-not-paying").find(".user-amount").val(0);
        $(".user-paying").find(".user-amount").each(function() {
          if ($(this).val() == 0) {
            $(this).val("")
          }
        });
      } else {
        calculatePercentOrUnitCharges(splitMethod);
      }
    }
    
    var calculateEqualCharges = function() {
      var numUsers = $(".user-paying").length;
      var equalAmount = $("#amount").val() / numUsers;
      $(".user-paying").find(".user-amount").val(equalAmount);
      $(".user-not-paying").find(".user-amount").val(0);
    };
    
    var calculatePercentOrUnitCharges = function(splitMethod) {
      // Calculate unit price
      if (splitMethod == "split-method-percent") {
        var totalUnits = 100;
      } else {
        var totalUnits = 0;
        $(".user-share").each(function() {
          totalUnits += Number($(this).val());
        });
      }
      var unitPrice = 0;
      if (totalUnits != 0) {
        unitPrice = $("#amount").val() / totalUnits;
      }
      
      // shares: fill checked rows with "" if 0, fill unchecked rows shares with 0
      // amounts: fill checked rows with amount, fill unchecked rows with 0
      $(".split-row").each(function() {
        var unitsInput = $(this).find(".user-share");
        var amountInput = $(this).find(".user-amount");
        if ($(this).hasClass("user-paying")) {
          var units = unitsInput.val();
          if (units == 0) {
            unitsInput.val("");
          }
          amountInput.val(unitPrice * units);
        } else {
          unitsInput.val(0);
          amountInput.val(0);
        }
      });
    }
    
    // Update charge table when user is selected or unselected
    $(".split-checkbox").click(function() {
      $(this).toggleClass("fa-check-square-o fa-square-o");
      $(this).parents(".split-row").toggleClass("user-paying user-not-paying");
      calculateCharges();
    });
    
    // Re-calculate charges when total amount changes
    $("#amount").change(calculateCharges);
    
    // Re-calculate charges when percent/unit amount changes
    $(".user-share").change(calculateCharges);
    
    // Change split method
    $(".split-method").click(function() {
      // hide any percent or unit specific elements
      $(".split-col-showing").toggleClass("hidden");
      $(".split-col-showing").toggleClass("split-col-showing split-col-hidden");
      
      var splitMethod = $(this).attr("id");
      
      // show percent/unit specific elements if percent/unit method chosen
      $("." + splitMethod).toggleClass("hidden");
      $("." + splitMethod).toggleClass("split-col-showing split-col-hidden");
      
      // set or unset readonly on dollar amount input
      if ((splitMethod == "split-method-equal" || splitMethod == "split-method-dollars") && $(".user-amount").attr("readonly")) {
        $(".user-amount").attr("readonly", false);
      } else if ((splitMethod == "split-method-percent" || splitMethod == "split-method-unit") && !$(".user-amount").attr("readonly")) {
        $(".user-amount").attr("readonly", true);
      }
      
      // switch active split method and recalculate charges
      $(".split-method-active").toggleClass("split-method-active split-method-inactive");
      $(this).toggleClass("split-method-active split-method-inactive");
      $(".user-amount").val("");
      $(".user-share").val("");
      calculateCharges();
    });
    
  });
</script>